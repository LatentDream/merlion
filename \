/* TODO: Refactoring in progress
 * - [x] New store package to encapsulate the Cloud behind an interface (will allow local storage)
 * - [ ] The backend should be able to receive nil ptr to the content & not delete the related content
 *       > remove the needs for internal/ui/manage/model.go:FetchNote
 * - [ ] The Note Metadata & the Content should be split
 *       > GetContent(noteId) (*string, *FetchCmd) <- Return on or the other ?
 */
package store

import (
	"log"
	"merlion/internal/model"
)

// Manager handles note operations through an underlying store implementation.
// Note: When using ListNoteMetadata() or accessing Manager.notes directly, note content
// may not be populated (content field may be nil). For guaranteed access to note
// content, use GetFullNote() which will always return the complete note with content.
type Manager struct {
	activeStore store
	name        string
	// notes contains a cached list of notes, but their content field may be nil
	// Use GetNote() to retrieve the complete note with content
	notes []model.Note
}

// NewManager creates a new manager with the given store implementation
// and initializes the notes list.
func NewManager(store store) *Manager {
	notes, err := store.ListNotes()
	if err != nil {
		log.Fatalf("Not able to list notes at the moment")
	}
	return &Manager{
		activeStore: store,
		name:        store.Name(),
		notes:       notes,
	}
}

// GetNote retrieves a specific note by ID.
// This method guarantees that the returned note will have its content field populated.
func (m *Manager) GetNote(noteID string) (*model.Note, error) {
	return m.activeStore.GetNote(noteID)
}

// ListNotes returns all notes from the store.
// Note: Returned notes may not have their content field populated.
// To access a note's content, use GetNote() with the note's ID.
func (m *Manager) ListNotes() ([]model.Note, error) {
	return m.activeStore.ListNotes()
}

// UpdateNote modifies an existing note with the provided changes.
func (m *Manager) UpdateNote(noteId string, changes model.CreateNoteRequest) (*model.Note, error) {
	return m.activeStore.UpdateNote(noteId, changes)
}

// GetTags returns all available tags from the store.
func (m *Manager) GetTags() []string {
	return m.activeStore.GetTags()
}

// CreateNote creates a new note with the provided request data.
func (m *Manager) CreateNote(req model.CreateNoteRequest) (*model.Note, error) {
	return m.activeStore.CreateNote(req)
}

// DeleteNote removes a note by its ID.
func (m *Manager) DeleteNote(noteID string) error {
	return m.activeStore.DeleteNote(noteID)
}
